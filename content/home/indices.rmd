---
# A Demo section created with the Blank widget.
# Any elements can be added in the body: https://sourcethemes.com/academic/docs/writing-markdown-latex/
# Add more sections by duplicating this file and customizing to your requirements.

widget: "blank"  # See https://sourcethemes.com/academic/docs/page-builder/
headless: true  # This file represents a page section.
active: true  # Activate this widget? true/false
weight: 3 # Order that this section will appear.

title: "Indices"
subtitle: ""

design:
  columns: "1"


---

```{r, echo=FALSE, message=FALSE,  warning=FALSE}
library(httr)
library(data.table)
library(plotly)    
library(RcppRoll)
library(lubridate)
transform_data = function(x){
  dates_total = seq(as.Date("2000-01-01"),as.Date(Sys.time()), by = 1)
  dat  = data.frame(timestamp = dates_total)
    
  x$timestamp =as.Date(x$timestamp)
  id.match = match(dat$timestamp,x$timestamp)
  dat$name = x$name[1]
  dat$value[!is.na(id.match)] = x$value
  dat$value[is.na(dat$value)] = 0
  dat$value[lubridate::wday(dat$timestamp) == 1] = NA
  if(dat$name[1] == "epu-wallonia"){
    dat$value[lubridate::year(dat$timestamp) == 2006] = NA
  }
  dat$MA = NA
  dat$ind = NA
  dat$MA[-1:-29] = RcppRoll::roll_mean(dat$value, 30,na.rm = TRUE)
  dat$ind[-1:-29] = RcppRoll::roll_sum(!is.na(dat$value), 30,na.rm = TRUE)
  dat$value2 = dat$value
  dat$value = dat$MA
  dat = dat[-1:-29,]
  dat$value[lubridate::wday(dat$timestamp) == 1] = NA
  dat$value[dat$ind < 20] = NA
  dat = dat[-1,]
  return(dat)

}
```
```{r, echo=FALSE, message=FALSE,  warning=FALSE}
auth <- POST("https://api-dev.sentometrics.com/token", 
             body = list(username=Sys.getenv("sento_username"),
                         password=Sys.getenv("sento_password")))

EPU_flanders_tmp <- data.table::rbindlist(content(GET("https://api-dev.sentometrics.com/index/values/epu-flanders", 
                                                        query = list(version="1.4.0",
                                                                frequency="D",
                                                                start= "2000-01-01",
                                                                end= as.character(as.Date(Sys.time()))),
                                                        add_headers(Authorization = paste0("Bearer ", content(auth)$access_token)))))

EPU_flanders = transform_data(EPU_flanders_tmp)

EPU_belgium_tmp <- data.table::rbindlist(content(GET("https://api-dev.sentometrics.com/index/values/epu-belgium", 
                                                     query = list(version="1.4.0",
                                                                frequency="D",
                                                                start= "2000-01-01",
                                                                end= as.character(as.Date(Sys.time()))),
                                                     add_headers(Authorization = paste0("Bearer ", content(auth)$access_token)))))

EPU_belgium = transform_data(EPU_belgium_tmp)

EPU_wal_tmp <- data.table::rbindlist(content(GET("https://api-dev.sentometrics.com/index/values/epu-wallonia", 
                                                    query = list(version="1.4.0",
                                                                frequency="D",
                                                                start= "2000-01-01",
                                                                end= as.character(as.Date(Sys.time()))),
                                                    add_headers(Authorization = paste0("Bearer ", content(auth)$access_token)))))

EPU_wal = transform_data(EPU_wal_tmp)

Indices = rbind(EPU_belgium[,c(1:3,6)],
                EPU_flanders[,c(1:3,6)],
                EPU_wal[,c(1:3,6)])
Indices = Indices[Indices$value2 != 0,]
colnames(Indices)[1] = "date"
```

```{r, echo=FALSE, message=FALSE,  warning=FALSE, out.width = "98%", out.height="95%"}
p <- Indices %>%
  plot_ly(
   type = 'scatter', 
   mode = 'lines+markers',
    x = ~date, 
    y = ~value,
    text      = ~paste('Date: ', date, '\n',
                           'Index: ', name, '\n',
                           '30-day moving average: ', value, '\n',
                           'Daily Value: ', value2, '\n'),
    hoverinfo = 'text',
    transforms = list(
      list(
        type = 'filter',
        target = ~name,
        operation = '=',
        value = unique(Indices$name)[1]
      )
  )) %>% layout(
    updatemenus = list(
      list(
        type = 'dropdown',
        active = 0,
        buttons = list(
          list(method = "restyle",
               args = list("transforms[0].value", unique(Indices$name)[1]),
               label = unique(Indices$name)[1]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(Indices$name)[2]),
               label = unique(Indices$name)[2]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(Indices$name)[3]),
               label = unique(Indices$name)[3])
        )
      )
    )
  )  %>% layout(autosize=T,height = 700)

p
```
